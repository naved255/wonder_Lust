<style>
    @keyframes heart {
        0% {
            transform: scale(1);
        }

        40% {
            transform: scale(1.3);
        }

        60% {
            transform: scale(0.9);
        }

        100% {
            transform: scale(1);
        }
    }

    @keyframes heart-shrink {
        0% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(0.85);
            opacity: .8;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .val-fail {
        outline: 1px solid rgb(230, 103, 103);
    }

    .val-pass {
        outline: 1px solid rgb(139, 234, 139);
    }

    .heart {
        position: absolute;
        top: 6px;
        right: 6px;
    }

    .hidden {
        visibility: hidden;
    }
</style>

<body>
    <% layout('./layout/boilerplate')-%>
    
    <!-- Success & Error Alerts -->
    <% if (success && success.length> 0) { %>
      <div class="alert alert-success alert-dismissible fade show rounded-0 mb-0" role="alert">
        <%= success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      <% } %>

        <% if (error && error.length> 0) { %>
          <div class="alert alert-danger alert-dismissible fade show rounded-0 mb-0" role="alert">
            <%= error %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          <% } %>

        <%if(info.length> 0) {%>
            <div class="d-flex justify-content-center align-item-center flex-wrap gap-2  w-100">
                <% for(let i of info) { %>
                    <%if(i.images.length> 0){%>
                        <a href="/user/<%=i.userId._id%>" class="card " style="width: 18rem; text-decoration: none;">
                            <img src="<%=i.images[0].path%>" class="card-img-top" alt="...">
                            <svg class="heart <%if(i.userId._id === userId){%> hidden<%}%> hover:scale-[120%] cursor-pointer position-absolute "
                                data-user="<%=i.userId._id%>" data-userid="<%=userId%>"
                                xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <path <%if(like !==undefined){ if(like.filter(item=> item.likedTo._id.toString() ===
                                    i.userId._id.toString()).length > 0){%>
                                    <path style="fill: rgb(245, 113, 113); stroke: transparent;" stroke-width="2" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
       2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09
       C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5
       c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                                    <%}else{%>
                                        <path style="fill: transparent; stroke: white;" stroke-width="2" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
       2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09
       C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5
       c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                                        <%}}else{%>
                                            <path style="fill: transparent; stroke: black;" stroke-width="2" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
       2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09
       C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5
       c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                                            <%}%>

                            </svg>
                            <div class="card-body">

                                <h5 class="card-title">
                                    <%=i.userId.username%>
                                </h5>
                                <p class="card-text text-truncate">
                                    <%=i.description%>
                                </p>
                                <div>
                                    <p class="card-text">
                                        Price: <%=i.price%>
                                    </p>
                                    <%if(i.reviews.length> 0) { let rating = 0;%>
                                        <%for(let el of i.reviews) { rating +=el.rating }
                                            rating=rating/i.reviews.length%>
                                            <div class="text-warning">
                                                rating:
                                                <% for(let i=0; i < rating; i++) { %> ‚≠ê <% } %>
                                            </div>
                                            <%} else {%>
                                                <div class="text-warning">
                                                    rating: NO_RATING
                                                </div>
                                                <%}%>
                                </div>
                            </div>
                        </a>

                        <%}%>
                            <%}%>
            </div>
            <%}else{%>
                <div class="font-bold text-4xl">loading....</div>
                <%}%>

                    <script>
                        let heart = document.querySelectorAll(".heart");


                        async function like(user, userId) {
                            let a = await fetch(`http://localhost:3000/user/like?user=${user}&userId=${userId}`, { method: 'POST' });
                            let res = await a.json();
                            if (res.liked) {
                                console.log(res.message);
                            } else {
                                console.log(res.message);
                            }
                        }

                        async function dislike(user, userId) {
                            let a = await fetch(`http://localhost:3000/user/dislike?user=${user}&userId=${userId}`, { method: 'POST' });
                            let res = await a.json();
                            if (res.liked) {
                                console.log(res.message);
                            } else {
                                console.log(res.message);
                            }
                        }


                        for (let h of heart) {
                            h.addEventListener("click", (e) => {
                                e.stopPropagation();
                                e.preventDefault();
                                let path = h.querySelector("path");
                                let user = h.dataset.user;
                                let userId = h.dataset.userid;
                                console.log(user, userId);

                                if (path.style.fill === 'transparent') {
                                    path.style.fill = 'rgb(245, 113, 113)'
                                    path.style.stroke = 'transparent'
                                    h.style.animation = 'none';
                                    h.offsetHeight;
                                    h.style.animation = 'heart 400ms ease-in-out  1 forwards'
                                    if (user !== undefined && userId !== undefined && user !== userId) {
                                        like(user, userId);
                                    }

                                } else {
                                    path.style.fill = 'transparent';
                                    path.style.stroke = 'white';
                                    h.style.animation = 'heart-shrink 400ms ease-in-out  1 forwards'
                                    if (user !== undefined && userId !== undefined && user !== userId) {
                                        dislike(user, userId);
                                    }

                                }
                            })
                        }

                    </script>

</body>